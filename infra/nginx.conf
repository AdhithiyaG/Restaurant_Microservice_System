worker_processes 1;

events { worker_connections 1024; }

http {
  upstream restaurant_service {
    server restaurant-service:3001;
  }
  upstream order_service {
    server order-service:3002;
  }
  upstream delivery_service {
    server delivery-service:3003;
  }
  upstream notification_service {
    server notification-service:3004;
  }

  server {
    listen 80;

    # Health
    location /healthz { return 200 'ok'; add_header Content-Type text/plain; }

    # Restaurant
    location /api/restaurant/ {
      proxy_pass http://restaurant_service/;
      proxy_set_header Host $host;
      proxy_set_header X-Request-Id $request_id;
    }

    # Order
    location /api/order/ {
      proxy_pass http://order_service/;
      proxy_set_header Host $host;
      proxy_set_header X-Request-Id $request_id;
    }

    # Delivery
    location /api/delivery/ {
      proxy_pass http://delivery_service/;
      proxy_set_header Host $host;
      proxy_set_header X-Request-Id $request_id;
      proxy_http_version 1.1;
      proxy_set_header Connection "";
      proxy_buffering off; # allow SSE/WebSocket-like streams
    }

    # Notification
    location /api/notification/ {
      proxy_pass http://notification_service/;
      proxy_set_header Host $host;
      proxy_set_header X-Request-Id $request_id;
    }

    # Static frontend (optional)
    location / {
      root /usr/share/nginx/html;
      try_files $uri /index.html;
    }
  }
}
